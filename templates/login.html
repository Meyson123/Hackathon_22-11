<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Вход - Хакатон Хаб</title>
    <link rel="stylesheet" href="/static/styles.css">
</head>
<body>
    <!-- Upper Navigation Hub -->
    <nav class="top-nav">
        <div class="nav-container">
            <button class="menu-btn" id="menuBtn">
                <span></span>
                <span></span>
                <span></span>
            </button>
            <div class="logo">
                <h1>Хакатон Хаб</h1>
            </div>
            <ul class="nav-links">
                <li><a href="/">Главная</a></li>
                <li><a href="registration.html">Регистрация</a></li>
                <li><a href="hackathons.html">Хакатоны</a></li>
                <li><a href="about.html">О нас</a></li>
            </ul>
        </div>
    </nav>

    <!-- Sidebar Hub -->
    <div class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <h2>Информационный Хаб</h2>
            <button class="close-btn" id="closeBtn">&times;</button>
        </div>
        <div class="sidebar-content">
            <div class="hub-section" id="participantsSection">
                <h3>Участники</h3>
                <div class="info-card">
                    <p><strong>Всего участников:</strong> 1,234</p>
                    <p><strong>Активных сейчас:</strong> 89</p>
                    <p><strong>Зарегистрировано в этом месяце:</strong> 156</p>
                </div>
            </div>
            <div class="hub-section" id="hackathonsSection">
                <h3>Хакатоны</h3>
                <div class="info-card">
                    <p><strong>Предстоящие:</strong> 12</p>
                    <p><strong>Текущие:</strong> 3</p>
                    <p><strong>Завершённые:</strong> 45</p>
                </div>
            </div>
            <div class="hub-section" id="coursesSection">
                <h3>Интенсивные Курсы</h3>
                <div class="info-card">
                    <p><strong>Доступных курсов:</strong> 8</p>
                    <p><strong>Записанных студентов:</strong> 567</p>
                    <p><strong>Процент завершения:</strong> 78%</p>
                </div>
            </div>
            <div class="hub-section" id="organizationsSection">
                <h3>Организации</h3>
                <div class="info-card">
                    <p><strong>Всего организаций:</strong> 24</p>
                    <p><strong>Активных партнёров:</strong> 18</p>
                    <p><strong>Опубликовано хакатонов:</strong> 67</p>
                </div>
            </div>
            <div class="hub-section" id="statisticsSection">
                <h3>Статистика</h3>
                <div class="info-card">
                    <p><strong>Всего проектов:</strong> 890</p>
                    <p><strong>Процент успеха:</strong> 82%</p>
                    <p><strong>Средний размер команды:</strong> 4.2</p>
                    <p><strong>Призовой фонд:</strong> $125,000</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Overlay -->
    <div class="overlay" id="overlay"></div>

    <!-- Login Form -->
    <main class="main-content">
        <div class="registration-container">
            <div class="registration-card">
                <h2>Вход в систему</h2>
                <p class="subtitle">Войдите в свой аккаунт</p>
                
                <form id="loginForm" class="registration-form">
                    <div class="form-group">
                        <label for="email">Email</label>
                        <input type="email" id="email" name="email" required>
                    </div>

                    <div class="form-group">
                        <label for="password">Пароль</label>
                        <input type="password" id="password" name="password" required>
                    </div>

                    <button type="submit" class="btn btn-primary btn-full">Войти</button>
                </form>

                <div class="login-links">
                    <p>Нет аккаунта? <a href="registration.html">Зарегистрируйтесь</a></p>
                </div>

                <div id="errorMessage" class="error-message" style="display: none;"></div>
                <div id="successMessage" class="success-message" style="display: none;"></div>
            </div>
        </div>
    </main>

    <script src="/static/script.js"></script>
    <script>
    // Login form handling
    const loginForm = document.getElementById('loginForm');

    async function handleLogin() {
        const errorMessage = document.getElementById('errorMessage');
        const successMessage = document.getElementById('successMessage');
        const submitButton = loginForm.querySelector('button[type="submit"]');

        submitButton.disabled = true;
        submitButton.textContent = 'Вход...';

        const formData = new FormData(loginForm);
        const data = {
            email: formData.get('email'),
            password: formData.get('password')
        };

        console.log('Sending login request:', data);

        try {
            const response = await fetch('/api/login', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(data)
            });

            let result;
            const contentType = response.headers.get('content-type');

            if (contentType && contentType.includes('application/json')) {
                result = await response.json();
            } else {
                const text = await response.text();
                throw new Error(`Сервер вернул HTML вместо JSON. Статус: ${response.status}`);
            }

            console.log('Login response:', result, 'Status:', response.status);

            if (response.ok) {
                successMessage.textContent = 'Успешный вход! Перенаправление...';
                successMessage.style.display = 'block';
                errorMessage.style.display = 'none';

                // Redirect based on role
                setTimeout(() => {
                    if (result.user.role === 'admin') {
                        window.location.href = 'admin.html';
                    } else {
                        window.location.href = '/';
                    }
                }, 1000);
            } else {
                errorMessage.textContent = result.detail || `Ошибка входа: ${response.status}`;
                errorMessage.style.display = 'block';
                successMessage.style.display = 'none';
            }
        } catch (error) {
            console.error('Login error:', error);
            errorMessage.textContent = error.message || 'Ошибка соединения с сервером';
            errorMessage.style.display = 'block';
            successMessage.style.display = 'none';
        } finally {
            submitButton.disabled = false;
            submitButton.textContent = 'Войти';
        }
    }

    loginForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        await handleLogin();
    });

    // Debug: Check URL parameters with proper decoding and auto-submit
    window.addEventListener('DOMContentLoaded', function() {
        const urlParams = new URLSearchParams(window.location.search);
        const email = urlParams.get('email');
        const password = urlParams.get('password');

        if (email && password) {
            // Декодируем email (превращаем %40 обратно в @)
            const decodedEmail = decodeURIComponent(email);
            document.getElementById('email').value = decodedEmail;
            document.getElementById('password').value = password;
            console.log('Auto-filled credentials from URL:', { email: decodedEmail, password });

            // Автоматически отправляем форму через небольшую задержку
            console.log('Auto-submitting form in 1 second...');
            setTimeout(() => {
                handleLogin();
            }, 1000);
        }
    });
</script>
</body>
</html>
