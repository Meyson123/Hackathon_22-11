<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–•–∞–∫–∞—Ç–æ–Ω—ã - –•–∞–∫–∞—Ç–æ–Ω –•–∞–±</title>
    <link rel="stylesheet" href="/static/styles.css">
</head>
<body>
    <!-- Upper Navigation Hub -->
    <nav class="top-nav">
        <div class="nav-container">
            <button class="menu-btn" id="menuBtn">
                <span></span>
                <span></span>
                <span></span>
            </button>
            <div class="logo">
                <h1>–•–∞–∫–∞—Ç–æ–Ω –•–∞–±</h1>
            </div>
            <ul class="nav-links">
                <li><a href="/">–ì–ª–∞–≤–Ω–∞—è</a></li>
                <li><a href="registration.html" id="registerLink">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</a></li>
                <li><a href="hackathons.html" class="active">–•–∞–∫–∞—Ç–æ–Ω—ã</a></li>
                <li><a href="about.html">–û –Ω–∞—Å</a></li>
                <li><a href="profile.html" id="profileLink" style="display: none;">–ü—Ä–æ—Ñ–∏–ª—å</a></li>
                <li><a href="login.html" id="loginLink">–í—Ö–æ–¥</a></li>
                <li><a href="/" id="logoutLink" style="display: none;">–í—ã—Ö–æ–¥</a></li>
                <li><a href="expert.html" id="expertLink" style="display: none;">–ü–∞–Ω–µ–ª—å —ç–∫—Å–ø–µ—Ä—Ç–∞</a></li>
                <li><a href="admin.html" id="adminLink" style="display: none;">–ê–¥–º–∏–Ω</a></li>
            </ul>
        </div>
    </nav>

    <!-- Sidebar Hub -->
    <div class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <h2>–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω—ã–π –•–∞–±</h2>
            <button class="close-btn" id="closeBtn">&times;</button>
        </div>
        <div class="sidebar-content">
            <div class="hub-section" id="participantsSection">
                <h3>–£—á–∞—Å—Ç–Ω–∏–∫–∏</h3>
                <div class="info-card">
                    <p><strong>–í—Å–µ–≥–æ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤:</strong> 1,234</p>
                    <p><strong>–ê–∫—Ç–∏–≤–Ω—ã—Ö —Å–µ–π—á–∞—Å:</strong> 89</p>
                    <p><strong>–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–æ –≤ —ç—Ç–æ–º –º–µ—Å—è—Ü–µ:</strong> 156</p>
                </div>
            </div>
            <div class="hub-section" id="hackathonsSection">
                <h3>–•–∞–∫–∞—Ç–æ–Ω—ã</h3>
                <div class="info-card">
                    <p><strong>–ü—Ä–µ–¥—Å—Ç–æ—è—â–∏–µ:</strong> 12</p>
                    <p><strong>–¢–µ–∫—É—â–∏–µ:</strong> 3</p>
                    <p><strong>–ó–∞–≤–µ—Ä—à—ë–Ω–Ω—ã–µ:</strong> 45</p>
                </div>
            </div>
            <div class="hub-section" id="coursesSection">
                <h3>–ò–Ω—Ç–µ–Ω—Å–∏–≤–Ω—ã–µ –ö—É—Ä—Å—ã</h3>
                <div class="info-card">
                    <p><strong>–î–æ—Å—Ç—É–ø–Ω—ã—Ö –∫—É—Ä—Å–æ–≤:</strong> 8</p>
                    <p><strong>–ó–∞–ø–∏—Å–∞–Ω–Ω—ã—Ö —Å—Ç—É–¥–µ–Ω—Ç–æ–≤:</strong> 567</p>
                    <p><strong>–ü—Ä–æ—Ü–µ–Ω—Ç –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è:</strong> 78%</p>
                </div>
            </div>
            <div class="hub-section" id="organizationsSection">
                <h3>–û—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏</h3>
                <div class="info-card">
                    <p><strong>–í—Å–µ–≥–æ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–π:</strong> 24</p>
                    <p><strong>–ê–∫—Ç–∏–≤–Ω—ã—Ö –ø–∞—Ä—Ç–Ω—ë—Ä–æ–≤:</strong> 18</p>
                    <p><strong>–û–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–æ —Ö–∞–∫–∞—Ç–æ–Ω–æ–≤:</strong> 67</p>
                </div>
            </div>
            <div class="hub-section" id="statisticsSection">
                <h3>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</h3>
                <div class="info-card">
                    <p><strong>–í—Å–µ–≥–æ –ø—Ä–æ–µ–∫—Ç–æ–≤:</strong> 890</p>
                    <p><strong>–ü—Ä–æ—Ü–µ–Ω—Ç —É—Å–ø–µ—Ö–∞:</strong> 82%</p>
                    <p><strong>–°—Ä–µ–¥–Ω–∏–π —Ä–∞–∑–º–µ—Ä –∫–æ–º–∞–Ω–¥—ã:</strong> 4.2</p>
                    <p><strong>–ü—Ä–∏–∑–æ–≤–æ–π —Ñ–æ–Ω–¥:</strong> $125,000</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Overlay -->
    <div class="overlay" id="overlay"></div>

    <!-- Main Content -->
    <main class="main-content">
        <div class="hero-section">
            <h2>–•–∞–∫–∞—Ç–æ–Ω—ã</h2>
            <p>–û—Ç–∫—Ä–æ–π—Ç–µ –¥–ª—è —Å–µ–±—è –∑–∞—Ö–≤–∞—Ç—ã–≤–∞—é—â–∏–µ —Å–æ—Ä–µ–≤–Ω–æ–≤–∞–Ω–∏—è –ø–æ –ø—Ä–æ–≥—Ä–∞–º–º–∏—Ä–æ–≤–∞–Ω–∏—é</p>
        </div>

        <!-- Filter Tabs -->
        <div class="filter-tabs">
            <button class="filter-btn active" data-filter="upcoming">–ü—Ä–µ–¥—Å—Ç–æ—è—â–∏–µ</button>
            <button class="filter-btn" data-filter="ongoing">–¢–µ–∫—É—â–∏–µ</button>
            <button class="filter-btn" data-filter="completed">–ó–∞–≤–µ—Ä—à—ë–Ω–Ω—ã–µ</button>
        </div>

        <!-- Upcoming Hackathons -->
        <section class="hackathons-section" id="upcoming">
            <h2 class="section-title">–ü—Ä–µ–¥—Å—Ç–æ—è—â–∏–µ –•–∞–∫–∞—Ç–æ–Ω—ã</h2>
            <div class="hackathons-grid" id="upcoming-hackathons">
                <p>–ó–∞–≥—Ä—É–∑–∫–∞...</p>
            </div>
        </section>

        <!-- Ongoing Hackathons -->
        <section class="hackathons-section" id="ongoing" style="display: none;">
            <h2 class="section-title">–¢–µ–∫—É—â–∏–µ –•–∞–∫–∞—Ç–æ–Ω—ã</h2>
            <div class="hackathons-grid" id="ongoing-hackathons">
                <p>–ó–∞–≥—Ä—É–∑–∫–∞...</p>
            </div>
        </section>

        <!-- Completed Hackathons -->
        <section class="hackathons-section" id="completed" style="display: none;">
            <h2 class="section-title">–ó–∞–≤–µ—Ä—à—ë–Ω–Ω—ã–µ –•–∞–∫–∞—Ç–æ–Ω—ã</h2>
            <div class="hackathons-grid" id="completed-hackathons">
                <p>–ó–∞–≥—Ä—É–∑–∫–∞...</p>
            </div>
        </section>

        <!-- Participation Modal -->
        <div id="participationModal" class="modal" style="display: none;">
            <div class="modal-content">
                <span class="close-modal">&times;</span>
                <h2>–£—á–∞—Å—Ç–∏–µ –≤ —Ö–∞–∫–∞—Ç–æ–Ω–µ</h2>
                <div id="participationOptions">
                    <div class="participation-option-buttons">
                        <button class="btn btn-primary btn-large" onclick="showCreateTeamForm()">–°–æ–∑–¥–∞—Ç—å –∫–æ–º–∞–Ω–¥—É</button>
                        <button class="btn btn-secondary btn-large" onclick="showJoinTeamForm()">–ü—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç—å—Å—è –∫ –∫–æ–º–∞–Ω–¥–µ</button>
                    </div>
                </div>
                
                <!-- Create Team Form -->
                <form id="createTeamForm" style="display: none;">
                    <input type="hidden" id="modalHackathonId">
                    <div class="form-group">
                        <label for="teamName">–ù–∞–∑–≤–∞–Ω–∏–µ –∫–æ–º–∞–Ω–¥—ã:</label>
                        <input type="text" id="teamName" required placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∫–æ–º–∞–Ω–¥—ã">
                    </div>
                    <div class="form-group">
                        <label for="teamDescription">–û–ø–∏—Å–∞–Ω–∏–µ –∫–æ–º–∞–Ω–¥—ã:</label>
                        <textarea id="teamDescription" rows="4" placeholder="–û–ø–∏—à–∏—Ç–µ –≤–∞—à—É –∫–æ–º–∞–Ω–¥—É, –Ω–∞–≤—ã–∫–∏, —Ü–µ–ª–∏ –∏ —Ç.–¥."></textarea>
                    </div>
                    <div class="form-actions">
                        <button type="button" class="btn btn-secondary" onclick="closeParticipationModal()">–û—Ç–º–µ–Ω–∞</button>
                        <button type="submit" class="btn btn-primary">–°–æ–∑–¥–∞—Ç—å –∫–æ–º–∞–Ω–¥—É</button>
                    </div>
                </form>
                
                <!-- Join Team Form -->
                <form id="joinTeamForm" style="display: none;">
                    <input type="hidden" id="joinHackathonId">
                    <div class="form-group">
                        <label for="teamCode">ID –∫–æ–º–∞–Ω–¥—ã:</label>
                        <input type="text" id="teamCode" placeholder="–í–≤–µ–¥–∏—Ç–µ ID –∫–æ–º–∞–Ω–¥—ã (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)">
                        <small style="color: #666; display: block; margin-top: 0.5rem;">–û—Å—Ç–∞–≤—å—Ç–µ –ø—É—Å—Ç—ã–º –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è</small>
                    </div>
                    <div id="availableTeamsList" style="display: none; margin-top: 1rem;">
                        <label>–î–æ—Å—Ç—É–ø–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã:</label>
                        <div id="teamsList"></div>
                    </div>
                    <div class="form-group" style="margin-top: 1.5rem; padding-top: 1.5rem; border-top: 1px solid #e5e7eb;">
                        <p style="margin-bottom: 1rem;">–ò–ª–∏ —É—á–∞—Å—Ç–≤—É–π—Ç–µ –±–µ–∑ –∫–æ–º–∞–Ω–¥—ã:</p>
                        <button type="button" class="btn btn-secondary btn-full" onclick="joinAsFreeParticipant()">–£—á–∞—Å—Ç–≤–æ–≤–∞—Ç—å –±–µ–∑ –∫–æ–º–∞–Ω–¥—ã</button>
                    </div>
                    <div class="form-actions">
                        <button type="button" class="btn btn-secondary" onclick="closeParticipationModal()">–û—Ç–º–µ–Ω–∞</button>
                        <button type="submit" class="btn btn-primary">–ü—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç—å—Å—è –∫ –∫–æ–º–∞–Ω–¥–µ</button>
                    </div>
                </form>
            </div>
        </div>
    </main>

    <script src="/static/script.js"></script>
    <style>
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.5);
        }
        .modal-content {
            background-color: #fefefe;
            margin: 15% auto;
            padding: 2rem;
            border: 1px solid #888;
            width: 90%;
            max-width: 500px;
            border-radius: 10px;
        }
        .close-modal {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
        .close-modal:hover {
            color: #000;
        }
        .form-group {
            margin-bottom: 1.5rem;
        }
        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
        }
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid #e5e7eb;
            border-radius: 5px;
            font-size: 1rem;
            font-family: inherit;
        }
        .form-group textarea {
            resize: vertical;
            min-height: 100px;
        }
        .btn-full {
            width: 100%;
        }
        .form-actions {
            display: flex;
            gap: 1rem;
            justify-content: flex-end;
        }
        .participation-info {
            margin-top: 1rem;
            padding: 0.75rem;
            background: #f0f9ff;
            border-radius: 5px;
            font-size: 0.9rem;
        }
        .participation-info strong {
            color: #667eea;
        }
        .participation-option-buttons {
            display: flex;
            flex-direction: column;
            gap: 1rem;
            margin-bottom: 1.5rem;
        }
        .btn-large {
            padding: 1rem 2rem;
            font-size: 1.1rem;
        }
        .team-item {
            padding: 0.75rem;
            border: 2px solid #e5e7eb;
            border-radius: 5px;
            margin-bottom: 0.5rem;
            cursor: pointer;
            transition: all 0.2s;
        }
        .team-item:hover {
            border-color: #667eea;
            background: #f0f9ff;
        }
        .team-item.selected {
            border-color: #667eea;
            background: #e0e7ff;
        }
        .team-item.team-disabled {
            opacity: 0.6;
            cursor: not-allowed !important;
            background: #f3f4f6;
        }
        .team-item.team-disabled:hover {
            border-color: #e5e7eb;
            background: #f3f4f6;
        }
    </style>
    <script>
        let currentUser = null;
        let userParticipations = {};

        // Update navigation on load
        if (typeof updateNavigation === 'function') {
            updateNavigation();
        }

        // Load current user and participations
        async function loadUserData() {
            try {
                const response = await fetch('/api/user');
                if (response.ok) {
                    currentUser = await response.json();
                    // Load user participations
                    const participationsResponse = await fetch('/api/participations');
                    if (participationsResponse.ok) {
                        const participations = await participationsResponse.json();
                        participations.forEach(p => {
                            userParticipations[p.hackathon_id] = p;
                        });
                    }
                }
            } catch (error) {
                console.error('Error loading user data:', error);
            }
        }

        // Load hackathons
        async function loadHackathons() {
            try {
                const [upcoming, ongoing, completed] = await Promise.all([
                    fetch('/api/hackathons?status_filter=upcoming').then(r => r.json()),
                    fetch('/api/hackathons?status_filter=ongoing').then(r => r.json()),
                    fetch('/api/hackathons?status_filter=completed').then(r => r.json())
                ]);

                renderHackathons(upcoming, 'upcoming-hackathons', 'upcoming');
                renderHackathons(ongoing, 'ongoing-hackathons', 'ongoing');
                renderHackathons(completed, 'completed-hackathons', 'completed');
            } catch (error) {
                console.error('Error loading hackathons:', error);
            }
        }

        function renderHackathons(hackathons, containerId, status) {
            const container = document.getElementById(containerId);
            if (hackathons.length === 0) {
                container.innerHTML = '<p>–•–∞–∫–∞—Ç–æ–Ω—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</p>';
                return;
            }

            container.innerHTML = hackathons.map(h => {
                const startDate = new Date(h.start_date);
                const endDate = new Date(h.end_date);
                const participation = userParticipations[h.id];
                const roleLabels = {
                    'captain': '–ö–∞–ø–∏—Ç–∞–Ω',
                    'team_member': '–£—á–∞—Å—Ç–Ω–∏–∫ –∫–æ–º–∞–Ω–¥—ã',
                    'free_participant': '–°–≤–æ–±–æ–¥–Ω—ã–π —É—á–∞—Å—Ç–Ω–∏–∫',
                    'expert': '–≠–∫—Å–ø–µ—Ä—Ç'
                };

                let buttonHtml = '';
                if (participation) {
                    buttonHtml = `
                        <div class="participation-info">
                            <strong>–í–∞—à–∞ —Ä–æ–ª—å:</strong> ${roleLabels[participation.role] || participation.role}<br>
                            <strong>–†–µ–ø—É—Ç–∞—Ü–∏—è:</strong> ${participation.reputation}
                        </div>
                        <button class="btn btn-secondary btn-full" disabled>–í—ã —É–∂–µ —É—á–∞—Å—Ç–≤—É–µ—Ç–µ</button>
                    `;
                } else if (status === 'completed') {
                    buttonHtml = '<button class="btn btn-secondary btn-full" disabled>–ó–∞–≤–µ—Ä—à—ë–Ω</button>';
                } else if (currentUser) {
                    buttonHtml = `<button class="btn btn-primary btn-full" onclick="openParticipationModal(${h.id})">–ü—Ä–∏–Ω—è—Ç—å —É—á–∞—Å—Ç–∏–µ</button>`;
                } else {
                    buttonHtml = '<a href="login.html" class="btn btn-primary btn-full">–í–æ–π—Ç–∏ –¥–ª—è —É—á–∞—Å—Ç–∏—è</a>';
                }

                return `
                    <div class="hackathon-card">
                        <div class="hackathon-badge ${status}">${status === 'upcoming' ? '–ü—Ä–µ–¥—Å—Ç–æ—è—â–∏–π' : status === 'ongoing' ? '–ò–¥—ë—Ç —Å–µ–π—á–∞—Å' : '–ó–∞–≤–µ—Ä—à—ë–Ω'}</div>
                        <h3>${h.name}</h3>
                        ${h.organizer ? `<p class="hackathon-org">–û—Ä–≥–∞–Ω–∏–∑–∞—Ç–æ—Ä: ${h.organizer}</p>` : ''}
                        ${h.description ? `<p class="hackathon-desc">${h.description}</p>` : ''}
                        <div class="hackathon-details">
                            <div class="detail-item">
                                <span class="detail-icon">üìÖ</span>
                                <span>${startDate.toLocaleDateString('ru-RU')} - ${endDate.toLocaleDateString('ru-RU')}</span>
                            </div>
                            ${h.duration_hours ? `
                            <div class="detail-item">
                                <span class="detail-icon">‚è±Ô∏è</span>
                                <span>${h.duration_hours} —á–∞—Å–æ–≤</span>
                            </div>
                            ` : ''}
                            ${h.prize_fund ? `
                            <div class="detail-item">
                                <span class="detail-icon">üí∞</span>
                                <span>${h.prize_fund}</span>
                            </div>
                            ` : ''}
                            ${h.max_team_size ? `
                            <div class="detail-item">
                                <span class="detail-icon">üë•</span>
                                <span>–î–æ ${h.max_team_size} —á–µ–ª–æ–≤–µ–∫</span>
                            </div>
                            ` : ''}
                        </div>
                        ${buttonHtml}
                    </div>
                `;
            }).join('');
        }

        let currentHackathonId = null;

        function openParticipationModal(hackathonId) {
            currentHackathonId = hackathonId;
            document.getElementById('modalHackathonId').value = hackathonId;
            document.getElementById('joinHackathonId').value = hackathonId;
            document.getElementById('participationModal').style.display = 'block';
            showParticipationOptions();
        }

        function showParticipationOptions() {
            document.getElementById('participationOptions').style.display = 'block';
            document.getElementById('createTeamForm').style.display = 'none';
            document.getElementById('joinTeamForm').style.display = 'none';
        }

        function showCreateTeamForm() {
            document.getElementById('participationOptions').style.display = 'none';
            document.getElementById('createTeamForm').style.display = 'block';
        }

        async function showJoinTeamForm() {
            document.getElementById('participationOptions').style.display = 'none';
            document.getElementById('joinTeamForm').style.display = 'block';
            
            // Load available teams
            try {
                const response = await fetch(`/api/hackathons/${currentHackathonId}/teams`);
                if (response.ok) {
                    const teams = await response.json();
                    const teamsList = document.getElementById('teamsList');
                    if (teams.length > 0) {
                        document.getElementById('availableTeamsList').style.display = 'block';
                        teamsList.innerHTML = teams.map(team => {
                            const isFull = team.max_team_size && team.member_count >= team.max_team_size;
                            const isClosed = team.recruitment_closed || false;
                            const canJoin = !isFull && !isClosed;
                            
                            return `
                                <div class="team-item ${!canJoin ? 'team-disabled' : ''}" ${canJoin ? `onclick="selectTeam(${team.id}, '${team.name}')"` : ''} style="${!canJoin ? 'opacity: 0.6; cursor: not-allowed;' : ''}">
                                    <strong>${team.name}</strong>
                                    ${isClosed ? '<span style="color: #ef4444; font-size: 0.85rem; margin-left: 0.5rem;">[–ù–∞–±–æ—Ä –∑–∞–∫—Ä—ã—Ç]</span>' : ''}
                                    ${isFull ? '<span style="color: #ef4444; font-size: 0.85rem; margin-left: 0.5rem;">[–ö–æ–º–∞–Ω–¥–∞ –∑–∞–ø–æ–ª–Ω–µ–Ω–∞]</span>' : ''}
                                    <br>
                                    ${team.description ? `<small style="color: #666; font-style: italic;">${team.description}</small><br>` : ''}
                                    <small>–ö–∞–ø–∏—Ç–∞–Ω: ${team.captain_fio || team.captain_username}</small><br>
                                    <small>–£—á–∞—Å—Ç–Ω–∏–∫–æ–≤: <strong>${team.member_count || 0}${team.max_team_size ? ` / ${team.max_team_size}` : ''}</strong></small>
                                    ${isFull ? '<br><small style="color: #ef4444;">‚ö†Ô∏è –ö–æ–º–∞–Ω–¥–∞ –¥–æ—Å—Ç–∏–≥–ª–∞ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–≥–æ —Ä–∞–∑–º–µ—Ä–∞</small>' : ''}
                                    ${isClosed ? '<br><small style="color: #ef4444;">‚ö†Ô∏è –ù–∞–±–æ—Ä –≤ –∫–æ–º–∞–Ω–¥—É –∑–∞–∫—Ä—ã—Ç</small>' : ''}
                                </div>
                            `;
                        }).join('');
                    }
                }
            } catch (error) {
                console.error('Error loading teams:', error);
            }
        }

        function selectTeam(teamId, teamName) {
            document.getElementById('teamCode').value = teamId;
            document.querySelectorAll('.team-item').forEach(item => {
                item.classList.remove('selected');
            });
            event.currentTarget.classList.add('selected');
        }

        async function joinAsFreeParticipant() {
            const hackathonId = parseInt(document.getElementById('joinHackathonId').value);

            try {
                const response = await fetch('/api/participations', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        hackathon_id: hackathonId,
                        role: 'free_participant'
                    })
                });

                const result = await response.json();
                if (response.ok) {
                    alert('–í—ã —É—Å–ø–µ—à–Ω–æ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–ª–∏—Å—å –Ω–∞ —Ö–∞–∫–∞—Ç–æ–Ω!');
                    closeParticipationModal();
                    await loadUserData();
                    await loadHackathons();
                } else {
                    alert(result.detail || '–û—à–∏–±–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º');
            }
        }

        function closeParticipationModal() {
            document.getElementById('participationModal').style.display = 'none';
            document.getElementById('createTeamForm').reset();
            document.getElementById('joinTeamForm').reset();
            document.getElementById('teamCode').value = '';
            document.getElementById('availableTeamsList').style.display = 'none';
            showParticipationOptions();
        }

        // Create Team form handler
        document.getElementById('createTeamForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const hackathonId = parseInt(document.getElementById('modalHackathonId').value);
            const teamName = document.getElementById('teamName').value;
            const teamDescription = document.getElementById('teamDescription').value;

            try {
                const response = await fetch('/api/participations', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        hackathon_id: hackathonId,
                        role: 'captain',
                        team_name: teamName,
                        team_description: teamDescription || null
                    })
                });

                const result = await response.json();
                if (response.ok) {
                    alert('–ö–æ–º–∞–Ω–¥–∞ —Å–æ–∑–¥–∞–Ω–∞! –í—ã —Å—Ç–∞–ª–∏ –∫–∞–ø–∏—Ç–∞–Ω–æ–º.');
                    closeParticipationModal();
                    await loadUserData();
                    await loadHackathons();
                } else {
                    alert(result.detail || '–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∫–æ–º–∞–Ω–¥—ã');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º');
            }
        });

        // Join Team form handler
        document.getElementById('joinTeamForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const hackathonId = parseInt(document.getElementById('joinHackathonId').value);
            const teamCode = document.getElementById('teamCode').value;

            // Check if team is full or closed before submitting
            if (teamCode) {
                try {
                    const teamResponse = await fetch(`/api/hackathons/${hackathonId}/teams`);
                    if (teamResponse.ok) {
                        const teams = await teamResponse.json();
                        const selectedTeam = teams.find(t => t.id == teamCode);
                        if (selectedTeam) {
                            const isFull = selectedTeam.max_team_size && selectedTeam.member_count >= selectedTeam.max_team_size;
                            const isClosed = selectedTeam.recruitment_closed || false;
                            
                            if (isClosed) {
                                alert('‚ö†Ô∏è –ù–∞–±–æ—Ä –≤ —ç—Ç—É –∫–æ–º–∞–Ω–¥—É –∑–∞–∫—Ä—ã—Ç. –í—ã–±–µ—Ä–∏—Ç–µ –¥—Ä—É–≥—É—é –∫–æ–º–∞–Ω–¥—É –∏–ª–∏ —É—á–∞—Å—Ç–≤—É–π—Ç–µ –±–µ–∑ –∫–æ–º–∞–Ω–¥—ã.');
                                return;
                            }
                            
                            if (isFull) {
                                alert(`‚ö†Ô∏è –ö–æ–º–∞–Ω–¥–∞ "${selectedTeam.name}" –¥–æ—Å—Ç–∏–≥–ª–∞ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–≥–æ —Ä–∞–∑–º–µ—Ä–∞ (${selectedTeam.member_count}/${selectedTeam.max_team_size}). –í—ã–±–µ—Ä–∏—Ç–µ –¥—Ä—É–≥—É—é –∫–æ–º–∞–Ω–¥—É –∏–ª–∏ —É—á–∞—Å—Ç–≤—É–π—Ç–µ –±–µ–∑ –∫–æ–º–∞–Ω–¥—ã.`);
                                return;
                            }
                        }
                    }
                } catch (error) {
                    console.error('Error checking team status:', error);
                }
            }

            try {
                const response = await fetch('/api/participations', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        hackathon_id: hackathonId,
                        role: 'team_member',
                        team_code: teamCode || null
                    })
                });

                const result = await response.json();
                if (response.ok) {
                    alert('–í—ã —É—Å–ø–µ—à–Ω–æ –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–∏–ª–∏—Å—å –∫ –∫–æ–º–∞–Ω–¥–µ!');
                    closeParticipationModal();
                    await loadUserData();
                    await loadHackathons();
                } else {
                    // Check if error is about team size
                    if (result.detail && (result.detail.includes('–º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–≥–æ —Ä–∞–∑–º–µ—Ä–∞') || result.detail.includes('–¥–æ—Å—Ç–∏–≥–ª–∞'))) {
                        alert(`‚ö†Ô∏è ${result.detail}\n\n–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –¥—Ä—É–≥—É—é –∫–æ–º–∞–Ω–¥—É –∏–ª–∏ —É—á–∞—Å—Ç–≤—É–π—Ç–µ –±–µ–∑ –∫–æ–º–∞–Ω–¥—ã.`);
                    } else {
                        alert(result.detail || '–û—à–∏–±–∫–∞ –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è –∫ –∫–æ–º–∞–Ω–¥–µ');
                    }
                }
            } catch (error) {
                console.error('Error:', error);
                alert('–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º');
            }
        });


        // Close modal on X click
        document.querySelector('.close-modal').addEventListener('click', closeParticipationModal);

        // Close modal on outside click
        window.onclick = function(event) {
            const modal = document.getElementById('participationModal');
            if (event.target === modal) {
                closeParticipationModal();
            }
        }
        
        // Filter functionality
        const filterBtns = document.querySelectorAll('.filter-btn');
        const hackathonSections = document.querySelectorAll('.hackathons-section');

        filterBtns.forEach(btn => {
            btn.addEventListener('click', () => {
                // Remove active class from all buttons
                filterBtns.forEach(b => b.classList.remove('active'));
                // Add active class to clicked button
                btn.classList.add('active');

                // Hide all sections
                hackathonSections.forEach(section => {
                    section.style.display = 'none';
                });

                // Show selected section
                const filter = btn.getAttribute('data-filter');
                const targetSection = document.getElementById(filter);
                if (targetSection) {
                    targetSection.style.display = 'block';
                    // Scroll to the section smoothly
                    setTimeout(() => {
                        targetSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
                    }, 100);
                }
            });
        });

        // Initialize on page load
        window.addEventListener('DOMContentLoaded', async () => {
            await loadUserData();
            await loadHackathons();
        });
    </script>
</body>
</html>

